

# **Setting Up GitLab CI Pipeline and Pre-Commit Hook to Scan for Secrets Using GitLeaks**

## **Overview**
Secrets such as API keys, credentials, and tokens should never be committed to source control. **GitLeaks** is an open-source tool designed to detect hardcoded secrets in repositories. This guide will walk you through:

1. **Configuring GitLeaks in GitLab CI/CD** to scan commits for secrets.
2. **Setting up a Git pre-commit hook** to run GitLeaks using Docker before allowing code commits.

By implementing these security measures, you can **prevent accidental exposure of secrets** in your repository.

---

## **Prerequisites**
Before proceeding, ensure the following:

- You have a **GitLab repository** set up.
- **Docker is installed** on your local machine (for running GitLeaks).
- You have **GitLab CI/CD** enabled for your repository.
- You have **Git** installed.

---

## **Step 1: Configuring GitLeaks in GitLab CI/CD**
To automate the scanning process, we will configure GitLab CI to run **GitLeaks** as part of the pipeline.

### **1.1 Create `.gitlab-ci.yml` File**
In the root of your GitLab project, create or edit the `.gitlab-ci.yml` file:

```yaml
stages:
  - security

gitleaks:
  stage: security
  image: zricethezav/gitleaks:v8.17.0  # Use the latest version
  script:
    - echo "Running GitLeaks security scan..."
    - gitleaks detect --source . --verbose --redact
  only:
    - main  # Run this job only on the main branch
```

### **1.2 Explanation**
- **Stages**: Defines the `security` stage.
- **Image**: Uses the official GitLeaks Docker image.
- **Script**:
  - Runs `gitleaks detect` to scan the repository.
  - The `--verbose` flag provides detailed output.
  - The `--redact` flag masks detected secrets.
- **Only**: Runs this job only on the `main` branch.

### **1.3 Commit and Push the Changes**
Save and commit the `.gitlab-ci.yml` file:

```sh
git add .gitlab-ci.yml
git commit -m "Add GitLeaks job to GitLab CI/CD"
git push origin main
```

Once pushed, GitLab will automatically trigger the pipeline, running the GitLeaks scan.

---

## **Step 2: Setting Up a Git Pre-Commit Hook for GitLeaks**
To **prevent secrets from being committed**, configure a **Git pre-commit hook** that scans changes using GitLeaks before allowing a commit.

### **2.1 Create the Pre-Commit Hook Script**
Navigate to your Git repository and create the **pre-commit hook**:

```sh
mkdir -p .git/hooks
touch .git/hooks/pre-commit
chmod +x .git/hooks/pre-commit
```

Edit the `pre-commit` file and add the following script:

```sh
#!/bin/bash

# Run GitLeaks using Docker to scan for secrets before committing
echo "Running GitLeaks pre-commit scan..."

docker run --rm -v "$(pwd):/repo" zricethezav/gitleaks:v8.17.0 detect --source /repo --verbose --redact

# Check the exit status of GitLeaks
if [ $? -ne 0 ]; then
    echo "ðŸš¨ GitLeaks detected potential secrets in your changes! Commit aborted."
    exit 1
else
    echo "âœ… No secrets detected. Proceeding with commit."
fi
```

### **2.2 Explanation**
- **Runs GitLeaks using Docker**: Ensures that GitLeaks is always up to date.
- **Scans the repository**: Uses the `detect` command.
- **Blocks commits if secrets are found**: Exits with status `1` if any secrets are detected.
- **Allows commits if no secrets are found**: Exits with status `0`.

### **2.3 Save and Apply the Hook**
Make sure the hook is executable:

```sh
chmod +x .git/hooks/pre-commit
```

---

## **Step 3: Testing the Configuration**
### **3.1 Test the Pre-Commit Hook**
Try to commit a file with a hardcoded secret:

```sh
echo "AWS_SECRET_KEY=123456789" > test.txt
git add test.txt
git commit -m "Test commit with secret"
```

If GitLeaks detects a secret, the commit will be blocked:

```plaintext
ðŸš¨ GitLeaks detected potential secrets in your changes! Commit aborted.
```

### **3.2 Test GitLab CI/CD**
Push a commit to GitLab and check the pipeline under **CI/CD > Pipelines**. If GitLeaks detects secrets, the pipeline will fail.

---

## **Step 4: Automating Secret Scanning for All Developers**
To enforce **GitLeaks scanning** for all contributors:
1. **Commit the pre-commit hook**: Share it in your repo under `.hooks/pre-commit` and add a setup script in `README.md`.

2. **Guide developers to set up hooks**: Instruct contributors to run:

   ```sh
   cp .hooks/pre-commit .git/hooks/pre-commit
   chmod +x .git/hooks/pre-commit
   ```

3. **Enforce GitLab CI/CD scanning**: Merge the `.gitlab-ci.yml` file into `main`.

---

## **Summary**
| Step | Description |
|------|------------|
| **Step 1** | Configure **GitLab CI/CD** to run **GitLeaks** as a pipeline job. |
| **Step 2** | Set up a **pre-commit hook** to scan code before commits. |
| **Step 3** | **Test** the pre-commit hook and GitLab CI pipeline. |
| **Step 4** | Automate scanning for all developers. |

By following these steps, your project will have **multiple layers of protection** against committing secrets, reducing security risks.

---

## **Next Steps**
- **Integrate with GitHub or Bitbucket** if needed.
- **Extend scanning** to include security checks for dependencies.
- **Automate notifications** using Slack or email alerts.

By implementing **GitLeaks in GitLab CI/CD and Git pre-commit hooks**, you can prevent secrets from leaking into your repositories and enhance your security posture. ðŸš€
```
